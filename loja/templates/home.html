{% extends "base.html" %}

{% block title %}Produtos - TechMart{% endblock %}
{% block header_title %}Produtos{% endblock %}

{% block extra_css %}
  /* Add home-specific styles here */
  .layout { display: flex; max-width: 1200px; margin: 20px auto; }
  .sidebar {
    width: 220px; background: #fff; border-radius: 10px;
    padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    margin-right: 20px; flex-shrink: 0;
    position: sticky; top: 20px;
    height: fit-content;
  }
  .sidebar h3 { margin-top: 0; color: #1d3557; }
  .sidebar ul { list-style: none; padding: 0; }
  .sidebar ul li { margin: 8px 0; }
  .sidebar ul li a {
    text-decoration: none; color: #1d3557; font-weight: bold;
  }
  .sidebar ul li a:hover { text-decoration: underline; }
  .filter-form { margin-bottom: 20px; }
    .filter-form input, .filter-form select, .filter-form button {
      padding: 8px; margin-bottom: 10px; width: 100%; border-radius: 5px; border: 1px solid #ccc;
    }
    .filter-form button {
      background: #1d3557; color: #fff; border: none; cursor: pointer; font-weight: bold;
    }
    .filter-form button:hover { background: #457b9d; }
  .products { flex-grow: 1; display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
  .product-card { background: #fff; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 20px; text-align: center; }
  .price { font-weight: bold; color: #1d3557; margin: 10px 0; font-size: 1.1em; }
  .rating { color: #f4c150; font-weight: bold; }
  /* New styles for additional product info */
  .product-meta {
    font-size: 0.85em;
    color: #666;
    margin: 8px 0;
    line-height: 1.4;
  }
  .product-meta div {
    margin: 3px 0;
  }
{% endblock %}
{% block content %}
  <div class="layout">

    <div class="sidebar">
      <h3>Filtrar Produtos</h3>
      <form method="get" class="filter-form">
        <input type="text" name="search" placeholder="Pesquisar produtos..." value="{{ request.GET.search }}">

        <select name="avaliacao">
          <option value="">Filtrar por Avaliação</option>
          {% for i in ratings %}
            <option value="{{ i }}" {% if request.GET.avaliacao == i|stringformat:"s" %}selected{% endif %}>{{ i }}★ e acima</option>
          {% endfor %}
        </select>

        <button type="submit">Filtrar</button>
      </form>

      <h3>Categorias</h3>
      <ul>
        <li><a href="?{% if request.GET.search %}search={{ request.GET.search }}&{% endif %}{% if request.GET.avaliacao %}avaliacao={{ request.GET.avaliacao }}{% endif %}">Todas</a></li>
        {% for cat in categorias %}
          <li><a href="?categoria={{ cat }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.avaliacao %}&avaliacao={{ request.GET.avaliacao }}{% endif %}">{{ cat }}</a></li>
        {% endfor %}
      </ul>
    </div>
    <div class="products">
      {% for produto in produtos %}
      <div class="card">
        <h3>{{ produto.nome }}</h3>
        <p class="descricao">{{ produto.descricao|truncatewords:15 }}</p>
        
        <!-- Additional product info -->
        <div class="product-meta">
          {% if produto.marca %}
            <div><strong>Marca:</strong> {{ produto.marca }}</div>
          {% endif %}
          {% if produto.categoria %}
            <div><strong>Categoria:</strong> {{ produto.categoria }}</div>
          {% endif %}
          {% if produto.condicao %}
            <div><strong>Condição:</strong> {{ produto.condicao|capfirst }}</div>
          {% endif %}
          {% if produto.fornecedor_nome %}
            <div><strong>Fornecedor:</strong> {{ produto.fornecedor_nome }}</div>
          {% endif %}
        </div>
        
        <!-- Price display with promotion if available -->
        <p class="price">
          {% if produto.preco_promocional %}
            <span style="text-decoration: line-through; color: #888;">€ {{ produto.preco }}</span>
            <span style="color: #e63946; font-weight: bold;">€ {{ produto.preco_promocional }}</span>
            <span style="background: #e63946; color: white; padding: 2px 5px; border-radius: 3px; font-size: 0.8em; margin-left: 5px;">
              Promoção!
            </span>
          {% else %}
            € {{ produto.preco }}
          {% endif %}
        </p>
        
        <!-- Rating display -->
        {% if produto.media_avaliacao %}
        <p class="rating">
          {% with ''|center:5 as range %}
            {% for i in range %}
              {% if forloop.counter <= produto.media_avaliacao|floatformat:0 %}
                ⭐
              {% else %}
                ☆
              {% endif %}
            {% endfor %}
          {% endwith %}
          ({{ produto.media_avaliacao|floatformat:1 }})
        </p>
        {% else %}
        <p class="rating">Sem avaliações</p>
        {% endif %}
        
        <!-- Action buttons -->
        <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 10px;">
          {% if request.session.user_id and request.session.tipo_usuario == 'cliente' %}
            <a href="{% url 'add_produto' produto.id %}" class="btn">Adicionar ao Carrinho</a>
            <a href="{% url 'produto_detail' produto.id %}" class="btn" style="background: #457b9d;">Ver Detalhes</a>
          {% elif request.session.user_id %}
            <span class="login-required">Disponível apenas para clientes</span>
            <a href="{% url 'produto_detail' produto.id %}" class="btn" style="background: #457b9d;">Ver Detalhes</a>
          {% else %}
            <a href="{% url 'login' %}" class="btn">Login para Comprar</a>
            <a href="{% url 'produto_detail' produto.id %}" class="btn" style="background: #457b9d;">Ver Detalhes</a>
          {% endif %}
        </div>
      </div>
      {% empty %}
      <p>Nenhum produto disponível.</p>
      {% endfor %}
    </div>

  </div>
{% endblock %}